const mongoose = require('mongoose');
const InventarioUnificado = require('./models/InventarioUnificado');
const inventarioMasterService = require('./services/InventarioMasterService');
const CatalogoProducto = require('./models/CatalogoProducto');

/**
 * SCRIPT DE TESTING FUNCIONALIDADES CR√çTICAS - FASE 1
 * 
 * Prueba todas las funcionalidades implementadas:
 * - Crear entradas de inventario
 * - Listar entradas con filtros
 * - Consumir stock
 * - Incrementar stock
 * - Obtener estad√≠sticas
 */

class TesterInventarioUnificado {
  constructor() {
    this.resultados = {
      total: 0,
      exitosos: 0,
      fallidos: 0,
      errores: []
    };
  }

  async ejecutarTests() {
    try {
      require('dotenv').config();
      await mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/superadmin');
      console.log('‚úÖ Conectado a MongoDB para testing\n');

      console.log('üß™ INICIANDO TESTING DE FUNCIONALIDADES CR√çTICAS');
      console.log('‚ïê'.repeat(60));
      
      // Tests principales
      await this._testCrearEntrada();
      await this._testListarEntradas();
      await this._testConsumirStock();
      await this._testIncrementarStock();
      await this._testObtenerEstadisticas();
      await this._testResumenPorProducto();
      
      // Mostrar resumen
      this._mostrarResumen();
      
    } catch (error) {
      console.error('üí• Error durante testing:', error);
    } finally {
      await mongoose.disconnect();
      console.log('üîå Desconectado de MongoDB');
    }
  }

  async _testCrearEntrada() {
    console.log('1Ô∏è‚É£ TESTING: Crear nueva entrada de inventario\n');
    
    try {
      // Obtener un producto del cat√°logo para usar en el test
      const catalogoProducto = await CatalogoProducto.findOne({ activo: true });
      
      if (!catalogoProducto) {
        throw new Error('No hay productos en el cat√°logo para testing');
      }

      const datosEntrada = {
        catalogoProductoId: catalogoProducto._id,
        cantidad: 100,
        precio: 15.50,
        precioVenta: 20.00,
        lote: 'TEST-LOTE-001',
        fechaEntrada: new Date(),
        fechaVencimiento: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 d√≠as
        proveedor: 'Proveedor Testing',
        observaciones: 'Entrada creada durante testing automatizado',
        usuario: 'tester',
        usuarioEmail: 'test@example.com',
        usuarioRole: 'admin'
      };

      console.log('üì¶ Datos de entrada de prueba:');
      console.log(`   - Producto: ${catalogoProducto.nombre}`);
      console.log(`   - Cantidad: ${datosEntrada.cantidad}`);
      console.log(`   - Precio: S/ ${datosEntrada.precio}`);
      console.log(`   - Lote: ${datosEntrada.lote}\n`);

      const entradaCreada = await inventarioMasterService.crearEntrada(datosEntrada);

      console.log('‚úÖ Entrada creada exitosamente:');
      console.log(`   - ID: ${entradaCreada._id}`);
      console.log(`   - N√∫mero de entrada: ${entradaCreada.numeroEntrada}`);
      console.log(`   - Estado: ${entradaCreada.estado}`);
      console.log(`   - Stock disponible: ${entradaCreada.cantidadDisponible}\n`);

      this._registrarExito('Crear entrada');
      
      // Guardar ID para tests posteriores
      this.entradaTestId = entradaCreada._id;
      
    } catch (error) {
      this._registrarError('Crear entrada', error);
    }
  }

  async _testListarEntradas() {
    console.log('2Ô∏è‚É£ TESTING: Listar entradas con filtros\n');
    
    try {
      // Test 1: Listar todas las entradas
      console.log('üîç Test 1: Listar todas las entradas...');
      const todasEntradas = await inventarioMasterService.listarEntradas();
      
      console.log(`   ‚úÖ Total de entradas: ${todasEntradas.entradas.length}`);
      console.log(`   üìä Stock total disponible: ${todasEntradas.resumen.stockTotalDisponible}`);
      console.log(`   üí∞ Valor total inventario: S/ ${todasEntradas.resumen.valorTotalInventario.toFixed(2)}\n`);

      // Test 2: Filtrar por estado activo
      console.log('üîç Test 2: Filtrar por estado activo...');
      const entradasActivas = await inventarioMasterService.listarEntradas({ 
        estado: 'activo' 
      }, { 
        limite: 10 
      });
      
      console.log(`   ‚úÖ Entradas activas: ${entradasActivas.entradas.length}`);
      console.log(`   üìÑ P√°ginas totales: ${entradasActivas.paginacion.totalPaginas}\n`);

      // Test 3: B√∫squeda por texto
      console.log('üîç Test 3: B√∫squeda por texto "Pizza"...');
      const busquedaPizza = await inventarioMasterService.listarEntradas({ 
        busqueda: 'Pizza' 
      });
      
      console.log(`   ‚úÖ Resultados encontrados: ${busquedaPizza.entradas.length}`);
      if (busquedaPizza.entradas.length > 0) {
        console.log(`   üì¶ Primer resultado: ${busquedaPizza.entradas[0].nombreProducto}`);
      }
      console.log();

      this._registrarExito('Listar entradas con filtros');
      
    } catch (error) {
      this._registrarError('Listar entradas con filtros', error);
    }
  }

  async _testConsumirStock() {
    console.log('3Ô∏è‚É£ TESTING: Consumir stock de entrada\n');
    
    try {
      if (!this.entradaTestId) {
        throw new Error('No hay entrada de test disponible');
      }

      // Obtener estado inicial
      const entradaInicial = await inventarioMasterService.obtenerEntrada(this.entradaTestId);
      const stockInicial = entradaInicial.cantidadDisponible;
      
      console.log(`üì¶ Stock inicial: ${stockInicial}`);
      
      // Consumir 10 unidades
      const cantidadConsumir = 10;
      console.log(`üîª Consumiendo ${cantidadConsumir} unidades...`);
      
      const entradaActualizada = await inventarioMasterService.consumirStock(
        this.entradaTestId,
        cantidadConsumir,
        {
          motivo: 'venta',
          observaciones: 'Consumo durante testing',
          usuario: 'tester'
        }
      );

      console.log(`‚úÖ Stock despu√©s del consumo: ${entradaActualizada.cantidadDisponible}`);
      console.log(`üìä Stock vendido: ${entradaActualizada.cantidadVendida}`);
      
      // Validar que el c√°lculo es correcto
      const stockEsperado = stockInicial - cantidadConsumir;
      if (entradaActualizada.cantidadDisponible === stockEsperado) {
        console.log('‚úÖ C√°lculo de stock correcto\n');
        this._registrarExito('Consumir stock');
      } else {
        throw new Error(`Stock incorrecto. Esperado: ${stockEsperado}, Actual: ${entradaActualizada.cantidadDisponible}`);
      }
      
    } catch (error) {
      this._registrarError('Consumir stock', error);
    }
  }

  async _testIncrementarStock() {
    console.log('4Ô∏è‚É£ TESTING: Incrementar stock (devoluci√≥n)\n');
    
    try {
      if (!this.entradaTestId) {
        throw new Error('No hay entrada de test disponible');
      }

      // Obtener estado actual
      const entradaInicial = await inventarioMasterService.obtenerEntrada(this.entradaTestId);
      const stockInicial = entradaInicial.cantidadDisponible;
      
      console.log(`üì¶ Stock antes de incremento: ${stockInicial}`);
      
      // Incrementar 5 unidades
      const cantidadIncrementar = 5;
      console.log(`üî∫ Incrementando ${cantidadIncrementar} unidades...`);
      
      const entradaActualizada = await inventarioMasterService.incrementarStock(
        this.entradaTestId,
        cantidadIncrementar,
        {
          motivo: 'devolucion',
          observaciones: 'Devoluci√≥n durante testing',
          usuario: 'tester'
        }
      );

      console.log(`‚úÖ Stock despu√©s del incremento: ${entradaActualizada.cantidadDisponible}`);
      console.log(`üìä Stock devuelto: ${entradaActualizada.cantidadDevuelta}`);
      
      // Validar que el c√°lculo es correcto
      const stockEsperado = stockInicial + cantidadIncrementar;
      if (entradaActualizada.cantidadDisponible === stockEsperado) {
        console.log('‚úÖ C√°lculo de incremento correcto\n');
        this._registrarExito('Incrementar stock');
      } else {
        throw new Error(`Stock incorrecto. Esperado: ${stockEsperado}, Actual: ${entradaActualizada.cantidadDisponible}`);
      }
      
    } catch (error) {
      this._registrarError('Incrementar stock', error);
    }
  }

  async _testObtenerEstadisticas() {
    console.log('5Ô∏è‚É£ TESTING: Obtener estad√≠sticas generales\n');
    
    try {
      const estadisticas = await inventarioMasterService.obtenerEstadisticasGenerales();

      console.log('üìà Estad√≠sticas generales obtenidas:');
      console.log(`   üìä Total entradas: ${estadisticas.resumen.totalEntradas}`);
      console.log(`   ‚úÖ Entradas activas: ${estadisticas.resumen.entradasActivas}`);
      console.log(`   üí∞ Valor total inventario: S/ ${estadisticas.resumen.valorTotalInventario.toFixed(2)}`);
      console.log(`   üè∑Ô∏è  Productos con stock: ${estadisticas.resumen.productosConStock}`);
      
      console.log('\nüö® Alertas:');
      console.log(`   ‚è∞ Pr√≥ximos a vencer: ${estadisticas.alertas.proximosVencer}`);
      console.log(`   üìâ Stock bajo: ${estadisticas.alertas.stockBajo}`);
      console.log(`   üîî Total alertas: ${estadisticas.alertas.totalAlertas}`);

      if (estadisticas.detalleAlertas.proximosVencer.length > 0) {
        console.log('\n‚è∞ Detalle productos pr√≥ximos a vencer:');
        estadisticas.detalleAlertas.proximosVencer.slice(0, 3).forEach((item, index) => {
          console.log(`   ${index + 1}. ${item.nombreProducto} - Vence en ${item.diasRestantes} d√≠as`);
        });
      }

      console.log();
      this._registrarExito('Obtener estad√≠sticas generales');
      
    } catch (error) {
      this._registrarError('Obtener estad√≠sticas generales', error);
    }
  }

  async _testResumenPorProducto() {
    console.log('6Ô∏è‚É£ TESTING: Resumen por producto\n');
    
    try {
      // Obtener un producto para el test
      const catalogoProducto = await CatalogoProducto.findOne({ activo: true });
      
      if (!catalogoProducto) {
        throw new Error('No hay productos disponibles para testing');
      }

      console.log(`üîç Obteniendo resumen para: ${catalogoProducto.nombre}`);
      
      const resumen = await inventarioMasterService.obtenerResumenPorProducto(catalogoProducto._id);

      console.log('üìä Resumen del producto:');
      console.log(`   üì¶ Stock total: ${resumen.stockTotal || 0}`);
      console.log(`   üîí Stock reservado: ${resumen.stockReservado || 0}`);
      console.log(`   üí∞ Valor total: S/ ${(resumen.valorTotal || 0).toFixed(2)}`);
      console.log(`   üìã N√∫mero de lotes: ${resumen.lotes || 0}`);
      
      if (resumen.proximoVencimiento) {
        console.log(`   ‚è∞ Pr√≥ximo vencimiento: ${new Date(resumen.proximoVencimiento).toLocaleDateString()}`);
      }
      
      console.log(`   üö® Alertas activas: ${resumen.alertas?.length || 0}`);

      console.log();
      this._registrarExito('Resumen por producto');
      
    } catch (error) {
      this._registrarError('Resumen por producto', error);
    }
  }

  _registrarExito(test) {
    this.resultados.total++;
    this.resultados.exitosos++;
    console.log(`‚úÖ TEST EXITOSO: ${test}\n`);
  }

  _registrarError(test, error) {
    this.resultados.total++;
    this.resultados.fallidos++;
    this.resultados.errores.push({ test, error: error.message });
    console.log(`‚ùå TEST FALLIDO: ${test}`);
    console.log(`   Error: ${error.message}\n`);
  }

  _mostrarResumen() {
    console.log('üìã RESUMEN DE TESTING');
    console.log('‚ïê'.repeat(60));
    console.log(`üß™ Tests ejecutados: ${this.resultados.total}`);
    console.log(`‚úÖ Tests exitosos: ${this.resultados.exitosos}`);
    console.log(`‚ùå Tests fallidos: ${this.resultados.fallidos}`);
    
    const porcentajeExito = this.resultados.total > 0 
      ? ((this.resultados.exitosos / this.resultados.total) * 100).toFixed(1)
      : 0;
    
    console.log(`üìä Porcentaje de √©xito: ${porcentajeExito}%`);

    if (this.resultados.errores.length > 0) {
      console.log('\n‚ùå ERRORES ENCONTRADOS:');
      this.resultados.errores.forEach((error, index) => {
        console.log(`   ${index + 1}. ${error.test}: ${error.error}`);
      });
    }

    console.log('‚ïê'.repeat(60));
    
    if (this.resultados.fallidos === 0) {
      console.log('üéâ ¬°TODOS LOS TESTS PASARON! El sistema est√° listo para producci√≥n.');
    } else {
      console.log('‚ö†Ô∏è  Algunos tests fallaron. Revisar errores antes de usar en producci√≥n.');
    }
  }
}

// Funci√≥n principal
async function ejecutarTests() {
  const tester = new TesterInventarioUnificado();
  await tester.ejecutarTests();
}

// Ejecutar si es llamado directamente
if (require.main === module) {
  ejecutarTests().catch(error => {
    console.error('Error fatal en testing:', error);
    process.exit(1);
  });
}

module.exports = TesterInventarioUnificado;